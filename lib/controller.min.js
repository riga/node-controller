/*!
 * node-controller module v0.1.4
 * https://github.com/riga/node-controller
 *
 * Marcel Rieger, 2014
 * Dual licensed under the MIT or GPL Version 3 licenses.
 * http://www.opensource.org/licenses/mit-license
 * http://www.opensource.org/licenses/GPL-3.0
 *
 * A lightweight, single-file Controller approach for node/express.
 */
var util=require("util");
var extend=require("node.extend"),Class=require("node-oo");var defaultConfig={base:"/",index:"index",scheme:"_%s_",caseSensitive:true};var Controller=Class._extend({init:function(b,a){this.parent=b||"root";
this.config=extend({},defaultConfig,a);this.__parNames={};},bind:function(b,a){b.use(this.middleware(a));return this;},middleware:function(c){var a=this;
if(c==null){c=this.config.base;}c=this._class.cutSlashes(c,"/","/");var b=new RegExp("^"+this._class.cutTrainlingSlash(c)+"(|/|/.+)$");return function(f,d,e){if(!a.config.caseSensitive){f.url=f._parsedUrl.pathname.toLowerCase()+(f._parsedUrl.search||"");
}if(b.test(f.url)){f.url=a._class.shiftUrl(f.url,c);a.__dispatch(f,d,e);}else{e();}};},__dispatch:function(f,c,e){var a=this._class.firstRoute(f.url)||this.config.index;
var d=this.__handler(a);if(this[a] instanceof Controller){f.url=this._class.shiftUrl(f.url);this[a].__dispatch(f,c,e);}else{if(this[d] instanceof Function){var b=this._class.cutQuery(f.url);
if(this._class.cutSlashes(b)!=a){var g=this._class.cutSlashes(this._class.shiftUrl(b,a)).split("/");if(g){f.params=this.__parseParams(a,g);}}this[d](f,c);
}else{e();}}return this;},__handler:function(a){return util.format(this.config.scheme,a);},setParNames:function(a,b){if(!this[this.__handler(a)]||!b){return this;
}if(!(b instanceof Array)){b=[b];}this.__parNames[a]=b;return this;},__parseParams:function(b,d){var c=this.__parNames[b]||[];var a={};d.forEach(function(f,e){a[c[e]||e]=f;
});return a;},findRoot:function(){var a=this.parent;while(a instanceof Controller){a=a.parent;}return a;},isRoot:function(){return this.findRoot()==this.parent;
},restrictMethod:function(c,b,a,d){if(!(a instanceof Array)){a=[a];}if(~a.indexOf(c.method)){if(d instanceof Function){d(c,b);}else{b.send(d||404);}return false;
}return true;},requireMethod:function(c,b,a,d){if(!(a instanceof Array)){a=[a];}if(!~a.indexOf(c.method)){if(d instanceof Function){d(c,b);}else{b.send(d||404);
}return false;}return true;},requireGET:function(b,a,c){return this.requireMethod(b,a,["GET"],c);},requirePOST:function(b,a,c){return this.requireMethod(b,a,["POST"],c);
},requirePUT:function(b,a,c){return this.requireMethod(b,a,["PUT"],c);}},{firstRoute:function(a){a=this.cutQuery(a);return this.cutLeadingSlash(a).split("/")[0];
},shiftUrl:function(b,a){a=a===undefined?this.firstRoute(b):this.cutSlashes(a);if(a){b=this.cutLeadingSlash(b);if(b.substr(0,a.length)==a){b=b.replace(a,"");
}}return this.cutLeadingSlash(b,"/");},cutTrainlingSlash:function(a,b){if(a[a.length-1]=="/"){a=a.slice(0,-1);}return a+(b||"");},cutLeadingSlash:function(a,b){if(a[0]=="/"){a=a.slice(1);
}return(b||"")+a;},cutSlashes:function(a,b,c){return this.cutTrainlingSlash(this.cutLeadingSlash(a,b),c);},cutQuery:function(a){return a.split("?")[0];
}});module.exports=Controller;