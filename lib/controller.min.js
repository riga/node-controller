var util=require("util");var extend=require("node.extend");var Class=require("./class.min");var defaultConfig={base:"/",index:"index",scheme:"_%s_",caseSensitive:true};
var Controller=Class.extend({init:function(b,a){this.parent=b||"root";this.config=extend({},defaultConfig,a);},bind:function(b,a){b.use(this.middleware(a));
return this;},middleware:function(c){var a=this;c=c||this.config.base;var b=new RegExp("^"+this.cutTrainlingSlash(c)+"(|/|/.+)$");return function(f,d,e){if(!a.config.caseSensitive){f.url=f._parsedUrl.pathname.toLowerCase()+(f._parsedUrl.search||"");
}if(b.test(f.url)){f.url=a.__shiftUrl(f.url,c);a.__dispatch(f,d,e);}else{e();}};},__dispatch:function(e,b,d){var a=this.__firstRoute(e.url)||this.config.index;
var c=this.__handler(a);if(this[a] instanceof Controller){e.url=this.__shiftUrl(e.url);this[a].__dispatch(e,b,d);}else{if(this[c] instanceof Function){this[c](e,b);
}else{d();}}return this;},__handler:function(a){return util.format(this.config.scheme,a);},__firstRoute:function(a){a=this.cutQuery(a);return this.cutLeadingSlash(a).split("/")[0];
},__shiftUrl:function(b,a){a=a===undefined?this.__firstRoute(b):this.cutSlashes(a);if(a){b=this.cutLeadingSlash(b);if(b.substr(0,a.length)==a){b=b.replace(a,"");
}}return this.cutLeadingSlash(b,"/");},findRoot:function(){var a=this.parent;while(a instanceof Controller){a=a.parent;}return a;},isRoot:function(){return this.findRoot()==this.parent;
},cutTrainlingSlash:function(a,b){if(a[a.length-1]=="/"){a=a.slice(0,-1);}return a+(b||"");},cutLeadingSlash:function(a,b){if(a[0]=="/"){a=a.slice(1);}return(b||"")+a;
},cutSlashes:function(a,b,c){return this.cutTrainlingSlash(this.cutLeadingSlash(a,b),c);},cutQuery:function(a){return a.split("?")[0];},__requireMethod:function(b,a,d,c){if(b.method!=d){if(c instanceof Function){c(b,a);
}else{a.send(c||404);}}return this;},requireGET:function(b,a,c){return this.__requireMethod(b,a,"GET",c);},requirePOST:function(b,a,c){return this.__requireMethod(b,a,"POST",c);
},requirePUT:function(b,a,c){return this.__requireMethod(b,a,"PUT",c);}});module.exports=Controller;